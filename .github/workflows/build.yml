name: 构建发布

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:

jobs:
    build-all:
        name: Docker 统一构建
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - name: 设置 Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: 缓存 Docker 层
              uses: actions/cache@v4
              with:
                  path: /tmp/.buildx-cache
                  key: ${{ runner.os }}-buildx-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-buildx-

            - name: 构建构建环境镜像
              uses: docker/build-push-action@v5
              with:
                  context: .devcontainer
                  file: .devcontainer/Dockerfile
                  push: false
                  load: true
                  tags: my-daw-builder:latest
                  cache-from: type=local,src=/tmp/.buildx-cache
                  cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

            - name: 移动缓存
              run: |
                  rm -rf /tmp/.buildx-cache
                  mv /tmp/.buildx-cache-new /tmp/.buildx-cache

            - name: 准备 Keystore
              run: |
                  mkdir -p keystore
                  keytool -genkey -v -keystore keystore/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"

            - name: 在 Docker 中构建所有产物
              run: |
                  docker run --rm \
                    -v ${{ github.workspace }}:/workspace \
                    -v ${{ github.workspace }}/keystore:/root/.android \
                    my-daw-builder:latest \
                    /bin/bash -c "
                      npm install && \
                      npm run tauri build -- --bundles appimage,rpm && \
                      npm run tauri build -- --runner cargo-xwin --target x86_64-pc-windows-msvc --bundles nsis && \
                      npm run tauri android build -- --apk --target aarch64-linux-android
                    "

            - name: 上传 Linux 产物
              uses: actions/upload-artifact@v4
              with:
                  name: desktop-linux
                  path: |
                      src-tauri/target/release/bundle/**/*.AppImage
                      src-tauri/target/release/bundle/**/*.appimage
                      src-tauri/target/release/bundle/**/*.rpm

            - name: 上传 Windows 产物
              uses: actions/upload-artifact@v4
              with:
                  name: desktop-windows
                  path: |
                      src-tauri/target/x86_64-pc-windows-msvc/release/bundle/**/*.exe

            - name: 上传 Android 产物
              uses: actions/upload-artifact@v4
              with:
                  name: android-app
                  path: src-tauri/gen/android/app/build/outputs/apk/**/*.apk

    publish-release:
        name: 发布 Release（汇总并上传所有平台资产）
        needs: [build-all]
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: 下载 Linux 产物
              uses: actions/download-artifact@v4
              with:
                  name: desktop-linux
                  path: artifacts/linux

            - name: 下载 Windows 产物
              uses: actions/download-artifact@v4
              with:
                  name: desktop-windows
                  path: artifacts/windows

            - name: 下载 Android 产物
              uses: actions/download-artifact@v4
              with:
                  name: android-app
                  path: artifacts/android

            - name: 列出待上传资产（调试）
              run: |
                  echo "Artifacts tree:"
                  ls -R artifacts || true

            - name: 创建 Release 并上传所有资产
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      artifacts/linux/**/*.AppImage
                      artifacts/linux/**/*.appimage
                      artifacts/linux/**/*.rpm
                      artifacts/windows/**/*.exe
                      artifacts/android/**/*.apk
                  tag_name: ${{ github.ref_name }}
                  name: 'App ${{ github.ref_name }}'
                  body: '请在下方 Assets 中下载安装包。'
                  draft: false
                  prerelease: false
                  overwrite_files: false
                  fail_on_unmatched_files: false
                  token: ${{ secrets.GITHUB_TOKEN }}
